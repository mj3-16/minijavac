#!/usr/bin/env sh

trap "exit" INT

# Set max time the compiler should optimize
MAXTIME=840 # 14 minutes
# Init STARTTIME with current runtime of the script
STARTTIME=$SECONDS

# Get project directory
case "$(uname -s)" in
   Darwin)
     SCRIPT_PATH=$(greadlink -f "$0")
     ;;

   *)
     SCRIPT_PATH=$(readlink -f "$0")
     ;;
esac

PROJECT_DIR=$(dirname "$SCRIPT_PATH")

# Check if more or less than the file is given
if [[ $# != 1 ]]; 
# if yes, just invoke compiler and redirect flags
then
# use the script generated by Gradle (does all the relative-path-magic for the dependencies)
$PROJECT_DIR/build_dir/install/minijavac/bin/minijavac $@

# if only the file is given, run compiler with different optimization levels
else 
# TimeLeft = Max Runtime - (Duration)
TIMELEFT=$(( MAXTIME - (SECONDS - STARTTIME)))
echo "Time left: $TIMELEFT seconds. Run compiler with flag -O 0"
# run compiler without optimization
MJ_OPT_TIME="$TIMELEFT" MJ_OUTPUTFILENAME="o0.out" $PROJECT_DIR/build_dir/install/minijavac/bin/minijavac -O 0 $@
mv o0.out a.out
mv o0.out.s a.out.s
mv o0.out.pre a.out.pre

TIMELEFT=$(( MAXTIME - (SECONDS - STARTTIME)))
echo "Time left: $TIMELEFT seconds. Run compiler with flag -O 1"
# run compiler with optimization level 1
MJ_OPT_TIME="$TIMELEFT" MJ_OUTPUTFILENAME="o1.out" $PROJECT_DIR/build_dir/install/minijavac/bin/minijavac -O 1 $@
mv o1.out a.out
mv o1.out.s a.out.s
mv o1.out.pre a.out.pre

TIMELEFT=$(( MAXTIME - (SECONDS - STARTTIME)))
echo "Time left: $TIMELEFT seconds. Run compiler with flag -O 2"
# run compiler with optimization level 2
MJ_OPT_TIME="$TIMELEFT" MJ_OUTPUTFILENAME="o2.out" $PROJECT_DIR/build_dir/install/minijavac/bin/minijavac -O 2 $@
mv o2.out a.out
mv o2.out.s a.out.s
mv o2.out.pre a.out.pre

TIMELEFT=$(( MAXTIME - (SECONDS - STARTTIME)))
echo "Time left: $TIMELEFT seconds. Run compiler with flag -O 3"
# run compiler with optimization level 3
MJ_OPT_TIME="$TIMELEFT" MJ_OUTPUTFILENAME="o3.out" $PROJECT_DIR/build_dir/install/minijavac/bin/minijavac -O 3 $@
mv o3.out a.out
mv o3.out.s a.out.s
mv o3.out.pre a.out.pre

DURATION=$((SECONDS - STARTTIME))
echo "Overall time used: $DURATION seconds"
fi